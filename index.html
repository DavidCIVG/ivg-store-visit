<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a1a1a">
    <title>IVG Store Visit</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root { --ivg-red: #E31937; --ivg-red-dark: #B8152C; --ivg-black: #1a1a1a; --bg-light: #f5f5f5; --text-primary: #1a1a1a; --text-secondary: #666; --border-color: #e0e0e0; --success: #22c55e; --danger: #ef4444; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0; background: var(--bg-light); color: var(--text-primary); min-height: 100vh; }
        
        /* Login Screen */
        .login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; background: linear-gradient(135deg, var(--ivg-black) 0%, #333 100%); }
        .login-box { background: white; padding: 40px 32px; border-radius: 16px; width: 100%; max-width: 360px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .login-logo { text-align: center; margin-bottom: 32px; }
        .login-logo .ivg { font-size: 36px; font-weight: 900; color: var(--ivg-black); }
        .login-logo .subtitle { font-size: 14px; color: var(--text-secondary); margin-top: 4px; }
        .login-input { width: 100%; padding: 16px; font-size: 18px; border: 2px solid var(--border-color); border-radius: 12px; text-align: center; letter-spacing: 8px; font-weight: 600; margin-bottom: 16px; outline: none; }
        .login-input:focus { border-color: var(--ivg-red); }
        .login-input::placeholder { letter-spacing: normal; }
        .login-btn { width: 100%; padding: 16px; background: var(--ivg-red); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .login-btn:disabled { opacity: 0.6; }
        .login-error { color: var(--danger); text-align: center; font-size: 13px; margin-top: 12px; display: none; }
        .login-error.show { display: block; }
        .unit-badge { background: var(--ivg-red); color: white; padding: 6px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; margin-bottom: 24px; }
        
        /* Main App */
        .app-container { display: none; }
        .app-container.active { display: block; }
        
        .header { background: var(--ivg-black); padding: 12px 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .header-content { display: flex; align-items: center; justify-content: space-between; max-width: 600px; margin: 0 auto; }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .header-unit { background: var(--ivg-red); color: white; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        .header-btns { display: flex; gap: 8px; }
        .admin-btn, .logout-btn { background: rgba(255,255,255,0.1); border: none; color: white; padding: 10px 14px; border-radius: 8px; font-size: 13px; cursor: pointer; }
        .admin-btn:hover, .logout-btn:hover { background: rgba(255,255,255,0.2); }
        
        .container { max-width: 600px; margin: 0 auto; padding: 16px; }
        .screen { display: none; }
        .screen.active { display: block; }
        
        .stats-banner { display: flex; gap: 12px; margin-bottom: 16px; }
        .stat-card { flex: 1; background: white; padding: 16px; border-radius: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .stat-card .number { font-size: 28px; font-weight: 700; color: var(--ivg-red); }
        .stat-card .label { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
        
        .search-box { position: relative; margin-bottom: 16px; }
        .search-input { width: 100%; padding: 16px 16px 16px 48px; font-size: 16px; border: 2px solid var(--border-color); border-radius: 12px; background: white; outline: none; }
        .search-input:focus { border-color: var(--ivg-red); }
        .search-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #999; }
        
        .store-list { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .store-item { padding: 16px; border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .store-item:last-child { border-bottom: none; }
        .store-item:active { background: #fef2f2; }
        .store-info h3 { margin: 0 0 4px 0; font-size: 16px; }
        .store-info p { margin: 0; font-size: 13px; color: var(--text-secondary); }
        .store-meta { text-align: right; }
        .store-code { background: var(--ivg-red); color: white; padding: 6px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; font-family: monospace; }
        .store-visits { font-size: 11px; color: var(--text-secondary); margin-top: 6px; }
        
        .new-store-btn, .submit-btn { width: 100%; padding: 18px; background: var(--ivg-red); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 16px; }
        
        .back-btn { display: flex; align-items: center; gap: 6px; color: var(--text-secondary); background: none; border: none; padding: 8px 0; font-size: 14px; cursor: pointer; margin-bottom: 12px; }
        
        .store-info-card { background: linear-gradient(135deg, #1a1a1a, #333); color: white; padding: 20px; border-radius: 12px; margin-bottom: 16px; }
        .store-info-card h2 { margin: 0 0 4px 0; font-size: 20px; }
        .store-info-card .code { font-family: monospace; background: var(--ivg-red); padding: 4px 8px; border-radius: 4px; font-size: 12px; display: inline-block; margin-bottom: 12px; }
        .store-info-card .details { font-size: 13px; opacity: 0.8; }
        .store-info-card .visit-count { margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.2); font-size: 12px; display: flex; justify-content: space-between; }
        
        .visit-history { background: white; border-radius: 12px; margin-bottom: 16px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .history-header { background: #f0f0f0; padding: 12px 16px; font-weight: 600; font-size: 14px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .history-list { max-height: 200px; overflow-y: auto; }
        .history-list.collapsed { display: none; }
        .history-item { padding: 12px 16px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
        .history-item:last-child { border-bottom: none; }
        .history-item .date { font-weight: 600; }
        .history-item .summary { color: var(--text-secondary); font-size: 12px; }
        .history-item .view-btn { background: none; border: 1px solid var(--ivg-red); color: var(--ivg-red); padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; }
        .history-badge { background: var(--ivg-red); color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; }
        
        .prefill-notice { background: #e8f5e9; border: 1px solid #a5d6a7; border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; font-size: 13px; color: #2e7d32; }
        
        .form-section { background: white; border-radius: 12px; margin-bottom: 16px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .section-header { background: linear-gradient(135deg, var(--ivg-red), var(--ivg-red-dark)); color: white; padding: 14px 16px; font-weight: 600; font-size: 14px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .section-header.collapsed .toggle-icon { transform: rotate(-90deg); }
        .toggle-icon { transition: transform 0.3s; }
        .section-content { padding: 16px; }
        .section-content.collapsed { display: none; }
        
        .field-group { margin-bottom: 16px; }
        .field-group:last-child { margin-bottom: 0; }
        .field-label { display: block; font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; }
        .field-label.required::after { content: ' *'; color: var(--ivg-red); }
        
        .text-input, .select-input, .textarea-input { width: 100%; padding: 12px 14px; font-size: 16px; border: 2px solid var(--border-color); border-radius: 8px; background: white; outline: none; }
        .text-input:focus, .select-input:focus, .textarea-input:focus { border-color: var(--ivg-red); }
        .textarea-input { min-height: 100px; resize: vertical; }
        
        .toggle-group { display: flex; gap: 8px; }
        .toggle-btn { padding: 10px 20px; border: 2px solid var(--border-color); border-radius: 8px; background: white; font-size: 14px; font-weight: 500; cursor: pointer; flex: 1; text-align: center; }
        .toggle-btn.yes.active { background: var(--success); border-color: var(--success); color: white; }
        .toggle-btn.no.active { background: var(--danger); border-color: var(--danger); color: white; }
        
        .checkbox-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; padding: 10px 12px; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; font-size: 13px; user-select: none; }
        .checkbox-item.checked { background: #fef2f2; border-color: var(--ivg-red); }
        .checkbox-box { width: 20px; height: 20px; border: 2px solid var(--border-color); border-radius: 4px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .checkbox-item.checked .checkbox-box { background: var(--ivg-red); border-color: var(--ivg-red); }
        .checkbox-box svg { opacity: 0; }
        .checkbox-item.checked .checkbox-box svg { opacity: 1; }
        
        .photo-section { background: white; border-radius: 12px; margin-bottom: 16px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .photo-header { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; padding: 14px 16px; font-weight: 600; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
        .photo-count-badge { background: white; color: #2563eb; padding: 2px 10px; border-radius: 10px; font-size: 12px; }
        .photo-content { padding: 16px; }
        .photo-upload-area { border: 2px dashed var(--border-color); border-radius: 12px; padding: 30px 24px; text-align: center; cursor: pointer; }
        .photo-upload-area:active { border-color: #2563eb; background: #eff6ff; }
        .photo-upload-area .icon { font-size: 40px; margin-bottom: 8px; }
        .photo-upload-area .text { font-size: 14px; color: var(--text-secondary); }
        .photo-preview-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 16px; }
        .photo-preview { position: relative; aspect-ratio: 1; border-radius: 10px; overflow: hidden; }
        .photo-preview img { width: 100%; height: 100%; object-fit: cover; }
        .photo-remove { position: absolute; top: 6px; right: 6px; width: 26px; height: 26px; background: rgba(239,68,68,0.9); border: none; border-radius: 50%; color: white; cursor: pointer; font-size: 16px; }
        
        .submit-section { position: sticky; bottom: 0; background: linear-gradient(to top, var(--bg-light) 80%, transparent); padding: 16px 0 24px; }
        .submit-note { text-align: center; font-size: 12px; color: var(--text-secondary); margin-bottom: 12px; }
        
        /* Toast */
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--ivg-black); color: white; padding: 14px 24px; border-radius: 12px; font-size: 14px; opacity: 0; transition: all 0.3s; z-index: 1000; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        
        /* Spinner */
        .spinner { width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: flex; align-items: center; justify-content: center; z-index: 500; flex-direction: column; gap: 16px; }
        .loading-overlay .spinner { width: 40px; height: 40px; border-width: 3px; border-color: var(--ivg-red); border-top-color: transparent; }
        
        /* Admin Panel */
        .admin-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 199; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .admin-overlay.open { opacity: 1; visibility: visible; }
        .admin-panel { position: fixed; top: 0; right: -100%; width: 100%; max-width: 440px; height: 100%; background: white; z-index: 200; transition: right 0.3s; overflow-y: auto; }
        .admin-panel.open { right: 0; }
        .admin-header { background: var(--ivg-black); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
        .admin-header h2 { margin: 0; font-size: 18px; }
        .admin-close { background: none; border: none; color: white; cursor: pointer; padding: 8px; font-size: 20px; }
        .admin-content { padding: 20px; }
        
        .admin-tabs { display: flex; gap: 8px; margin-bottom: 20px; }
        .admin-tab { flex: 1; padding: 12px; border: 2px solid var(--border-color); background: white; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; }
        .admin-tab.active { background: var(--ivg-red); border-color: var(--ivg-red); color: white; }
        
        .admin-section { display: none; }
        .admin-section.active { display: block; }
        
        /* Field Config Item - Enhanced */
        .field-config-item { background: #f9f9f9; border-radius: 10px; padding: 14px; margin-bottom: 10px; }
        .field-config-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .field-config-name { font-weight: 600; font-size: 14px; }
        .field-config-meta { font-size: 11px; color: var(--text-secondary); }
        .field-config-actions { display: flex; gap: 6px; }
        .field-action-btn { width: 32px; height: 32px; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .field-action-btn.edit { background: #e0e7ff; color: #4f46e5; }
        .field-action-btn.delete { background: #fee2e2; color: var(--danger); }
        .field-action-btn.toggle { background: #e0e0e0; color: #666; }
        .field-action-btn.toggle.active { background: var(--success); color: white; }
        
        /* Add/Edit Field Form */
        .field-form { background: #f0f0f0; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .field-form h3 { margin: 0 0 16px 0; font-size: 16px; color: var(--ivg-red); }
        .form-row { margin-bottom: 14px; }
        .form-row label { display: block; font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; }
        .form-row input, .form-row select { width: 100%; padding: 10px 12px; font-size: 14px; border: 2px solid var(--border-color); border-radius: 8px; background: white; outline: none; }
        .form-row input:focus, .form-row select:focus { border-color: var(--ivg-red); }
        .form-btns { display: flex; gap: 10px; margin-top: 16px; }
        .form-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .form-btn.primary { background: var(--ivg-red); color: white; }
        .form-btn.secondary { background: #e0e0e0; color: #666; }
        
        .section-group { margin-bottom: 24px; }
        .section-group-title { font-size: 12px; font-weight: 700; color: var(--ivg-red); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid var(--ivg-red); }
        
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
        .empty-state h3 { margin: 16px 0 8px; color: var(--text-primary); }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 300; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-overlay.open { display: flex; }
        .modal-content { background: white; border-radius: 12px; max-width: 500px; width: 100%; max-height: 80vh; overflow-y: auto; }
        .modal-header { background: var(--ivg-black); color: white; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { margin: 0; font-size: 16px; }
        .modal-close { background: none; border: none; color: white; font-size: 20px; cursor: pointer; }
        .modal-body { padding: 20px; }
        .modal-body .detail-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-color); font-size: 14px; }
        .modal-body .detail-label { color: var(--text-secondary); }
        .modal-body .detail-value { font-weight: 500; text-align: right; max-width: 60%; }
        .modal-photos { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 16px; }
        .modal-photos a { display: block; border-radius: 8px; overflow: hidden; }
        .modal-photos img { width: 100%; aspect-ratio: 1; object-fit: cover; }
        
        .offline-banner { background: #f59e0b; color: white; text-align: center; padding: 8px; font-size: 12px; display: none; }
        .offline-banner.show { display: block; }
        
        /* Confirm Dialog */
        .confirm-dialog { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 400; display: none; align-items: center; justify-content: center; padding: 20px; }
        .confirm-dialog.open { display: flex; }
        .confirm-box { background: white; border-radius: 12px; padding: 24px; max-width: 320px; width: 100%; text-align: center; }
        .confirm-box h4 { margin: 0 0 12px 0; }
        .confirm-box p { color: var(--text-secondary); font-size: 14px; margin: 0 0 20px 0; }
        .confirm-btns { display: flex; gap: 10px; }
        .confirm-btns button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .confirm-btns .cancel { background: #e0e0e0; }
        .confirm-btns .confirm { background: var(--danger); color: white; }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="login-screen">
        <div class="login-box">
            <div class="login-logo">
                <div class="ivg">IVG</div>
                <div class="subtitle">Store Visit App</div>
            </div>
            <div class="unit-badge" id="unit-badge">IRELAND</div>
            <input type="password" class="login-input" id="login-pin" placeholder="PIN" maxlength="6" inputmode="numeric">
            <button class="login-btn" id="login-btn" onclick="attemptLogin()">Login</button>
            <div class="login-error" id="login-error">Incorrect PIN</div>
        </div>
    </div>
    
    <!-- Main App -->
    <div class="app-container" id="app-container">
        <div class="offline-banner" id="offline-banner">‚ö†Ô∏è Offline</div>
        <div class="loading-overlay" id="loading-overlay">
            <div class="spinner"></div>
            <div>Loading...</div>
        </div>
        
        <header class="header">
            <div class="header-content">
                <div class="header-left">
                    <span style="font-size: 20px; font-weight: 900; color: white;">IVG</span>
                    <span class="header-unit" id="header-unit">IE</span>
                </div>
                <div class="header-btns">
                    <button class="admin-btn" onclick="toggleAdmin()">‚öôÔ∏è</button>
                    <button class="logout-btn" onclick="logout()">‚Ü©</button>
                </div>
            </div>
        </header>
        
        <div class="container">
            <!-- Store List Screen -->
            <div id="screen-select" class="screen active">
                <div class="stats-banner">
                    <div class="stat-card"><div class="number" id="total-stores">0</div><div class="label">Stores</div></div>
                    <div class="stat-card"><div class="number" id="total-visits">0</div><div class="label">Visits</div></div>
                </div>
                <div class="search-box">
                    <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                    <input type="text" class="search-input" id="store-search" placeholder="Search stores...">
                </div>
                <div class="store-list" id="store-list"></div>
                <button class="new-store-btn" onclick="startNewStore()">+ Add New Store</button>
            </div>
            
            <!-- Form Screen -->
            <div id="screen-form" class="screen">
                <button class="back-btn" onclick="showScreen('select')">‚Üê Back</button>
                <div class="store-info-card" id="store-card" style="display:none;">
                    <span class="code" id="card-code"></span>
                    <h2 id="card-name"></h2>
                    <div class="details" id="card-details"></div>
                    <div class="visit-count"><span id="card-visit-count"></span><span id="card-last-visit"></span></div>
                </div>
                <div class="visit-history" id="visit-history" style="display:none;">
                    <div class="history-header" onclick="toggleHistory()"><span>üìÖ History</span><span class="history-badge" id="history-count">0</span></div>
                    <div class="history-list" id="history-list"></div>
                </div>
                <div class="prefill-notice" id="prefill-notice" style="display:none;">‚úì Pre-filled from last visit</div>
                <div id="form-sections-container"></div>
                <div class="photo-section">
                    <div class="photo-header"><span>üì∏ Photos</span><span class="photo-count-badge" id="photo-count-badge">0</span></div>
                    <div class="photo-content">
                        <div class="photo-upload-area" onclick="document.getElementById('photo-input').click()">
                            <div class="icon">üì∑</div>
                            <div class="text">Tap to add photos</div>
                        </div>
                        <input type="file" id="photo-input" accept="image/*" capture="environment" multiple style="display:none" onchange="handlePhotos(this)">
                        <div class="photo-preview-grid" id="photo-previews"></div>
                    </div>
                </div>
                <div class="submit-section">
                    <div class="submit-note" id="submit-note"></div>
                    <button class="submit-btn" id="submit-btn" onclick="submitVisit()">Submit Visit</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Admin Panel -->
    <div class="admin-overlay" id="admin-overlay" onclick="toggleAdmin()"></div>
    <div class="admin-panel" id="admin-panel">
        <div class="admin-header">
            <h2>‚öôÔ∏è Admin</h2>
            <button class="admin-close" onclick="toggleAdmin()">‚úï</button>
        </div>
        <div class="admin-content">
            <div class="admin-tabs">
                <button class="admin-tab active" onclick="showAdminTab('fields',this)">Fields</button>
                <button class="admin-tab" onclick="showAdminTab('add',this)">+ Add</button>
            </div>
            
            <!-- Fields List -->
            <div id="admin-fields" class="admin-section active">
                <div id="field-config-list"></div>
            </div>
            
            <!-- Add/Edit Field -->
            <div id="admin-add" class="admin-section">
                <div class="field-form" id="field-form">
                    <h3 id="field-form-title">+ Add Field</h3>
                    <input type="hidden" id="edit-field-id">
                    <div class="form-row">
                        <label>Field Label</label>
                        <input type="text" id="field-label" placeholder="e.g. Stock Count">
                    </div>
                    <div class="form-row">
                        <label>Field Type</label>
                        <select id="field-type" onchange="toggleOptionsRow()">
                            <option value="text">Text</option>
                            <option value="number">Number</option>
                            <option value="yesno">Yes / No</option>
                            <option value="select">Dropdown</option>
                            <option value="multiselect">Multi-Select</option>
                            <option value="textarea">Notes (multi-line)</option>
                        </select>
                    </div>
                    <div class="form-row" id="options-row" style="display:none;">
                        <label>Options (comma separated)</label>
                        <input type="text" id="field-options" placeholder="Option 1, Option 2, Option 3">
                    </div>
                    <div class="form-row">
                        <label>Section</label>
                        <select id="field-section">
                            <option value="business">üìç Business</option>
                            <option value="products">üì¶ Products</option>
                            <option value="gantry">üóÑÔ∏è Gantry</option>
                            <option value="sales">üìä Sales</option>
                            <option value="orders">üõí Orders</option>
                            <option value="pos">üè∑Ô∏è POS</option>
                            <option value="competitors">üèÜ Competitors</option>
                            <option value="notes">üìù Notes</option>
                        </select>
                    </div>
                    <div class="form-btns">
                        <button class="form-btn secondary" onclick="cancelFieldEdit()">Cancel</button>
                        <button class="form-btn primary" onclick="saveField()">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Visit Detail Modal -->
    <div class="modal-overlay" id="visit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Visit Details</h3>
                <button class="modal-close" onclick="closeModal()">‚úï</button>
            </div>
            <div class="modal-body" id="modal-body"></div>
        </div>
    </div>
    
    <!-- Confirm Delete Dialog -->
    <div class="confirm-dialog" id="confirm-dialog">
        <div class="confirm-box">
            <h4>Delete Field?</h4>
            <p id="confirm-message">Are you sure you want to delete this field?</p>
            <div class="confirm-btns">
                <button class="cancel" onclick="closeConfirm()">Cancel</button>
                <button class="confirm" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>

<script>
// ============ CONFIGURATION ============
// Set these for each deployment
const CONFIG = {
    API_URL: 'https://script.google.com/macros/s/AKfycbw2d7I-4vXphPa-rftpaqHGPfuqVmkQOemIEZv3NMOeYJdC4thuqGCFnFdsn86bfPOdjg/exec',
    UNIT_NAME: 'IRELAND',
    UNIT_CODE: 'IE',
    STORE_PREFIX: 'IVG-IE-',
    PIN: '1234',       // User login PIN
    ADMIN_PIN: '2233'  // Admin panel PIN
};

// ============ STATE ============
let isLoggedIn = false;
let isAdminUnlocked = false;
let currentStore = null;
let isNewStore = false;
let lastVisitData = null;
let photos = [];
let formData = {};
let stores = [];
let visits = [];
let fieldConfig = [];
let deleteFieldId = null;

const sectionMeta = {
    business: { icon: 'üìç', title: 'Business', open: true },
    products: { icon: 'üì¶', title: 'Products', open: true },
    gantry: { icon: 'üóÑÔ∏è', title: 'Gantry' },
    sales: { icon: 'üìä', title: 'Sales' },
    orders: { icon: 'üõí', title: 'Orders' },
    pos: { icon: 'üè∑Ô∏è', title: 'POS' },
    competitors: { icon: 'üèÜ', title: 'Competitors' },
    notes: { icon: 'üìù', title: 'Notes', open: true }
};

// ============ LOGIN ============
document.getElementById('unit-badge').textContent = CONFIG.UNIT_NAME;
document.getElementById('header-unit').textContent = CONFIG.UNIT_CODE;

document.getElementById('login-pin').addEventListener('keyup', e => {
    if (e.key === 'Enter') attemptLogin();
});

function attemptLogin() {
    const pin = document.getElementById('login-pin').value;
    if (pin === CONFIG.PIN) {
        isLoggedIn = true;
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-container').classList.add('active');
        initApp();
    } else {
        document.getElementById('login-error').classList.add('show');
        document.getElementById('login-pin').value = '';
        setTimeout(() => document.getElementById('login-error').classList.remove('show'), 2000);
    }
}

function logout() {
    isLoggedIn = false;
    isAdminUnlocked = false;
    document.getElementById('app-container').classList.remove('active');
    document.getElementById('login-screen').style.display = 'flex';
    document.getElementById('login-pin').value = '';
}

// ============ API ============
async function apiGet(action, params = {}) {
    const url = new URL(CONFIG.API_URL);
    url.searchParams.set('action', action);
    Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
    const r = await fetch(url);
    return r.json();
}

async function apiPost(action, data) {
    const form = new FormData();
    form.append('action', action);
    form.append('data', JSON.stringify(data));
    const r = await fetch(CONFIG.API_URL, { method: 'POST', body: form });
    return r.json();
}

// ============ INIT ============
async function initApp() {
    if (!navigator.onLine) document.getElementById('offline-banner').classList.add('show');
    window.addEventListener('online', () => document.getElementById('offline-banner').classList.remove('show'));
    window.addEventListener('offline', () => document.getElementById('offline-banner').classList.add('show'));
    
    try {
        const [storesRes, visitsRes, statsRes, configRes] = await Promise.all([
            apiGet('getStores'),
            apiGet('getVisits'),
            apiGet('getStats'),
            apiGet('getConfig')
        ]);
        
        if (storesRes?.stores) stores = storesRes.stores;
        if (visitsRes?.visits) visits = visitsRes.visits;
        // Use server config if it exists, otherwise use defaults
        if (configRes?.fields && configRes.fields.length > 0) {
            fieldConfig = configRes.fields;
        } else {
            // First time setup - use defaults and save to server
            fieldConfig = getDefaultFields();
            saveConfigToServer();
        }
        
        document.getElementById('total-stores').textContent = statsRes?.totalStores || 0;
        document.getElementById('total-visits').textContent = statsRes?.totalVisits || 0;
    } catch(e) {
        console.error('Init error:', e);
        fieldConfig = getDefaultFields();
    }
    
    renderStoreList();
    renderFieldConfigList();
    document.getElementById('loading-overlay').style.display = 'none';
}

function getDefaultFields() {
    return [
        // Business section
        { id: 'business_name', label: 'Business Name', type: 'text', section: 'business', required: true, active: true },
        { id: 'business_type', label: 'Business Type', type: 'select', section: 'business', required: true, active: true, options: ['Vape Store','Vape Chain','FMCG','Wholesaler','Convenience','Phone Repair'] },
        { id: 'address', label: 'Address', type: 'text', section: 'business', required: true, active: true },
        { id: 'postcode', label: 'Post Code', type: 'text', section: 'business', active: true },
        { id: 'store_location', label: 'Town/Area', type: 'text', section: 'business', active: true },
        { id: 'contact', label: 'Contact', type: 'text', section: 'business', active: true },
        { id: 'phone', label: 'Phone', type: 'text', section: 'business', active: true },
        { id: 'email', label: 'Email', type: 'text', section: 'business', active: true },
        { id: 'main_supplier', label: 'Main Supplier', type: 'select', section: 'business', active: true, options: ['HALE','CLAYTON','E-CIRETTE','JFC','NEWVEND','CHINMARA','UK WHOLESALE','FLEMING','SMOKEGREEN','AMPERSAND','KADONA','OTHER'] },
        
        // Products section
        { id: 'has_ivg2400', label: 'Has IVG 2400?', type: 'yesno', section: 'products', active: true },
        { id: 'ivg2400_sku', label: '2400 SKU Count', type: 'number', section: 'products', active: true },
        { id: 'has_smart5500', label: 'Has SMART 5500?', type: 'yesno', section: 'products', active: true },
        { id: 'smart_sku', label: '5500 SKU Count', type: 'number', section: 'products', active: true },
        { id: 'has_pro12', label: 'Has PRO-12?', type: 'yesno', section: 'products', active: true },
        { id: 'pro_sku', label: 'PRO-12 SKU Count', type: 'number', section: 'products', active: true },
        { id: 'has_savr', label: 'Has IVG SAVR?', type: 'yesno', section: 'products', active: true },
        { id: 'has_10ml_salts', label: 'Has 10ML Salts?', type: 'yesno', section: 'products', active: true },
        { id: 'has_5050', label: 'Has 50/50?', type: 'yesno', section: 'products', active: true },
        
        // Gantry section
        { id: 'gantry_share', label: 'Gantry % IVG', type: 'number', section: 'gantry', active: true },
        { id: 'ivg2400_units_wide', label: '2400 Units Wide', type: 'number', section: 'gantry', active: true },
        { id: 'smart5500_units_wide', label: '5500 Units Wide', type: 'number', section: 'gantry', active: true },
        { id: 'ivg2400_placement', label: '2400 Placement', type: 'multiselect', section: 'gantry', active: true, options: ['Counter','Eye Level','Top','Middle','Bottom'] },
        
        // Sales section
        { id: 'devices_daily_sales', label: 'Devices/Day', type: 'number', section: 'sales', active: true },
        { id: 'liquids_daily_sales', label: 'Liquids/Day', type: 'number', section: 'sales', active: true },
        
        // Orders section
        { id: 'order_placed', label: 'Order Placed?', type: 'yesno', section: 'orders', active: true },
        { id: 'devices_order_volume', label: 'Order Volume', type: 'number', section: 'orders', active: true },
        { id: 'devices_order_frequency', label: 'Order Frequency', type: 'select', section: 'orders', active: true, options: ['DAILY','WEEKLY','10 DAYS','14 DAYS','30 DAYS'] },
        
        // POS section
        { id: 'pos_allowed', label: 'POS Allowed?', type: 'yesno', section: 'pos', active: true },
        { id: 'has_brand_pos', label: 'Has Brand POS?', type: 'yesno', section: 'pos', active: true },
        { id: 'brand_pos_required', label: 'POS Needed', type: 'multiselect', section: 'pos', active: true, options: ['Door Signs','Floor Mats','Counter Mats','Shelf Strips','Wobblers'] },
        { id: 'merch_request', label: 'Merch Request', type: 'text', section: 'pos', active: true },
        
        // Competitors section
        { id: 'devices_competitor1', label: 'Top Device Competitor', type: 'select', section: 'competitors', active: true, options: ['LOST MARY','VUSE','ELF BAR','HAYATTI','SKE','GOLD BAR'] },
        { id: 'liquids_competitor1', label: 'Top Liquid Competitor', type: 'select', section: 'competitors', active: true, options: ['RIOT','DINNER LADY','VAMPIRE VAPE','NASTY JUICE','ELFLIQ','OTHER'] },
        
        // Notes section
        { id: 'notes', label: 'Notes', type: 'textarea', section: 'notes', active: true }
    ];
}

// ============ HELPERS ============
function getStoreVisits(code) { 
    return visits.filter(v => v.store_code === code).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)); 
}
function formatDate(d) { return new Date(d).toLocaleDateString('en-GB', { day:'numeric', month:'short' }); }
function formatDateTime(d) { return new Date(d).toLocaleDateString('en-GB', { day:'numeric', month:'short', hour:'2-digit', minute:'2-digit' }); }

// ============ STORE LIST ============
function renderStoreList(filter = '') {
    const list = document.getElementById('store-list');
    const f = filter.toLowerCase();
    const filtered = stores.filter(s => (s.name||'').toLowerCase().includes(f) || (s.code||'').toLowerCase().includes(f));
    
    if (!filtered.length) {
        list.innerHTML = '<div class="empty-state"><h3>No stores found</h3></div>';
        return;
    }
    
    list.innerHTML = filtered.map(s => {
        const v = getStoreVisits(s.code);
        return `<div class="store-item" onclick="selectStore('${s.code}')">
            <div class="store-info"><h3>${s.name}</h3><p>${s.location||''}</p></div>
            <div class="store-meta"><span class="store-code">${s.code}</span><div class="store-visits">${v.length} visits</div></div>
        </div>`;
    }).join('');
}

document.getElementById('store-search').addEventListener('input', e => renderStoreList(e.target.value));

// ============ SELECT STORE ============
function selectStore(code) {
    currentStore = stores.find(s => s.code === code);
    isNewStore = false;
    const sv = getStoreVisits(code);
    lastVisitData = sv[0] || null;
    
    document.getElementById('store-card').style.display = 'block';
    document.getElementById('card-code').textContent = currentStore.code;
    document.getElementById('card-name').textContent = currentStore.name;
    document.getElementById('card-details').textContent = `${currentStore.location||''} ‚Ä¢ ${currentStore.type||''}`;
    document.getElementById('card-visit-count').textContent = `${sv.length} visits`;
    document.getElementById('card-last-visit').textContent = lastVisitData ? `Last: ${formatDate(lastVisitData.timestamp)}` : '';
    
    renderVisitHistory(sv);
    document.getElementById('prefill-notice').style.display = lastVisitData ? 'block' : 'none';
    document.getElementById('submit-note').textContent = `Create visit #${sv.length + 1}`;
    
    renderForm(false);
    if (lastVisitData) prefillForm(lastVisitData);
    photos = [];
    updatePhotoUI();
    showScreen('form');
}

function renderVisitHistory(sv) {
    const el = document.getElementById('visit-history');
    if (!sv.length) { el.style.display = 'none'; return; }
    el.style.display = 'block';
    document.getElementById('history-count').textContent = sv.length;
    document.getElementById('history-list').innerHTML = sv.map((v,i) => {
        const tags = [];
        if (v.order_placed === 'YES') tags.push('üì¶');
        if (parseInt(v.photo_count) > 0) tags.push(`üì∑${v.photo_count}`);
        return `<div class="history-item">
            <div><div class="date">${formatDateTime(v.timestamp)}</div><div class="summary">${tags.join(' ')||'-'}</div></div>
            <button class="view-btn" onclick="viewVisit(${i})">View</button>
        </div>`;
    }).join('');
}

function toggleHistory() { document.getElementById('history-list').classList.toggle('collapsed'); }

function viewVisit(i) {
    const v = getStoreVisits(currentStore.code)[i];
    document.getElementById('modal-title').textContent = formatDateTime(v.timestamp);
    
    let html = '';
    fieldConfig.filter(f => f.active && f.section !== 'business').forEach(f => {
        if (v[f.id]) html += `<div class="detail-row"><span class="detail-label">${f.label}</span><span class="detail-value">${v[f.id]}</span></div>`;
    });
    
    if (v.photo_links) {
        const links = v.photo_links.split(' | ').filter(l => l);
        if (links.length) {
            html += `<div style="margin-top:16px;font-weight:600;">üì∑ Photos</div>
            <div class="modal-photos">${links.map(l => {
                const id = l.match(/\/d\/([^\/]+)/)?.[1]||'';
                return `<a href="${l}" target="_blank"><img src="https://drive.google.com/thumbnail?id=${id}&sz=w200"></a>`;
            }).join('')}</div>`;
        }
    }
    
    document.getElementById('modal-body').innerHTML = html || '<p>No data recorded</p>';
    document.getElementById('visit-modal').classList.add('open');
}

function closeModal() { document.getElementById('visit-modal').classList.remove('open'); }

function startNewStore() {
    currentStore = null;
    isNewStore = true;
    lastVisitData = null;
    
    document.getElementById('store-card').style.display = 'none';
    document.getElementById('visit-history').style.display = 'none';
    document.getElementById('prefill-notice').style.display = 'none';
    document.getElementById('submit-note').textContent = 'Create new store + first visit';
    
    clearForm();
    photos = [];
    updatePhotoUI();
    renderForm(true);
    showScreen('form');
}

function showScreen(s) {
    document.querySelectorAll('.screen').forEach(x => x.classList.remove('active'));
    document.getElementById('screen-' + s).classList.add('active');
    if (s === 'select') {
        document.getElementById('store-search').value = '';
        renderStoreList();
    }
}

// ============ FORM RENDERING ============
function renderForm(showBusiness) {
    const container = document.getElementById('form-sections-container');
    container.innerHTML = '';
    
    // Group fields by section
    const sections = {};
    fieldConfig.filter(f => f.active).forEach(f => {
        if (!sections[f.section]) sections[f.section] = [];
        sections[f.section].push(f);
    });
    
    Object.entries(sections).forEach(([sid, fields]) => {
        if (sid === 'business' && !showBusiness) return;
        
        const m = sectionMeta[sid] || { icon: 'üìã', title: sid };
        const collapsed = m.open ? '' : 'collapsed';
        
        container.innerHTML += `
            <div class="form-section">
                <div class="section-header ${collapsed}" onclick="toggleSection(this)">
                    <span>${m.icon} ${m.title}</span>
                    <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content ${collapsed}">
                    ${fields.map(f => renderField(f)).join('')}
                </div>
            </div>`;
    });
    
    setupFormListeners();
}

function renderField(f) {
    const req = f.required ? 'required' : '';
    let input = '';
    
    switch(f.type) {
        case 'text':
        case 'number':
            input = `<input type="${f.type}" class="text-input" id="${f.id}">`;
            break;
        case 'textarea':
            input = `<textarea class="textarea-input" id="${f.id}"></textarea>`;
            break;
        case 'select':
            input = `<select class="select-input" id="${f.id}">
                <option value="">Select...</option>
                ${(f.options||[]).map(o => `<option value="${o}">${o}</option>`).join('')}
            </select>`;
            break;
        case 'yesno':
            input = `<div class="toggle-group">
                <button type="button" class="toggle-btn yes" data-field="${f.id}" data-value="YES">YES</button>
                <button type="button" class="toggle-btn no" data-field="${f.id}" data-value="NO">NO</button>
            </div>`;
            break;
        case 'multiselect':
            input = `<div class="checkbox-grid" data-field="${f.id}">
                ${(f.options||[]).map(o => `
                    <div class="checkbox-item" data-value="${o}">
                        <span class="checkbox-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></span>
                        <span>${o}</span>
                    </div>
                `).join('')}
            </div>`;
            break;
    }
    
    return `<div class="field-group"><label class="field-label ${req}">${f.label}</label>${input}</div>`;
}

function setupFormListeners() {
    // Yes/No toggles
    document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.onclick = function() {
            this.parentElement.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            formData[this.dataset.field] = this.dataset.value;
        };
    });
    
    // Multi-select checkboxes
    document.querySelectorAll('.checkbox-item').forEach(item => {
        item.onclick = function(e) {
            e.preventDefault();
            this.classList.toggle('checked');
        };
    });
}

function prefillForm(v) {
    formData = { ...v };
    
    fieldConfig.forEach(f => {
        const val = v[f.id];
        if (!val) return;
        
        const el = document.getElementById(f.id);
        
        if (['text','number','textarea','select'].includes(f.type) && el) {
            el.value = val;
        } else if (f.type === 'yesno') {
            const btn = document.querySelector(`[data-field="${f.id}"][data-value="${val}"]`);
            if (btn) {
                btn.parentElement.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
        } else if (f.type === 'multiselect' && val) {
            const vals = val.split(', ');
            document.querySelectorAll(`[data-field="${f.id}"] .checkbox-item`).forEach(item => {
                if (vals.includes(item.dataset.value)) item.classList.add('checked');
            });
        }
    });
}

function toggleSection(header) {
    header.classList.toggle('collapsed');
    header.nextElementSibling.classList.toggle('collapsed');
}

// ============ PHOTOS ============
function handlePhotos(input) {
    Array.from(input.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = e => compressImage(e.target.result, 500, 0.5, img => { photos.push(img); updatePhotoUI(); });
        reader.readAsDataURL(file);
    });
    input.value = '';
}

function compressImage(dataUrl, maxSize, quality, cb) {
    const img = new Image();
    img.onload = () => {
        const canvas = document.createElement('canvas');
        let w = img.width, h = img.height;
        if (w > h && w > maxSize) { h = h * maxSize / w; w = maxSize; }
        else if (h > maxSize) { w = w * maxSize / h; h = maxSize; }
        canvas.width = w;
        canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        cb(canvas.toDataURL('image/jpeg', quality));
    };
    img.src = dataUrl;
}

function updatePhotoUI() {
    document.getElementById('photo-count-badge').textContent = photos.length;
    document.getElementById('photo-previews').innerHTML = photos.map((p,i) => 
        `<div class="photo-preview"><img src="${p}"><button class="photo-remove" onclick="photos.splice(${i},1);updatePhotoUI()">‚úï</button></div>`
    ).join('');
}

// ============ FORM SUBMISSION ============
function collectFormData() {
    const data = { ...formData };
    
    // Text inputs
    document.querySelectorAll('.text-input, .textarea-input, .select-input').forEach(inp => {
        if (inp.id) data[inp.id] = inp.value;
    });
    
    // Multi-selects
    document.querySelectorAll('.checkbox-grid').forEach(grid => {
        const checked = Array.from(grid.querySelectorAll('.checkbox-item.checked')).map(i => i.dataset.value);
        data[grid.dataset.field] = checked.join(', ');
    });
    
    return data;
}

function clearForm() {
    formData = {};
    document.querySelectorAll('.text-input, .textarea-input').forEach(el => el.value = '');
    document.querySelectorAll('.select-input').forEach(el => el.selectedIndex = 0);
    document.querySelectorAll('.toggle-btn').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.checkbox-item').forEach(el => el.classList.remove('checked'));
}

async function submitVisit() {
    const btn = document.getElementById('submit-btn');
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner"></div> Saving...';
    
    try {
        const data = collectFormData();
        data.is_new_store = isNewStore;
        data.timestamp = new Date().toISOString();
        if (!isNewStore) data.store_code = currentStore.code;
        if (photos.length) data.photos = photos;
        
        const result = await apiPost('addVisit', data);
        
        if (result?.success) {
            const code = result.storeCode || currentStore?.code;
            
            if (isNewStore) {
                stores.push({
                    code,
                    name: data.business_name,
                    location: data.store_location || data.address,
                    type: data.business_type
                });
            }
            
            data.store_code = code;
            data.photo_count = result.photoCount || 0;
            visits.unshift(data);
            
            showToast(`Saved!${result.photoCount ? ` + ${result.photoCount} photos` : ''}`, 'success');
            
            setTimeout(() => {
                showScreen('select');
                document.getElementById('total-stores').textContent = stores.length;
                document.getElementById('total-visits').textContent = visits.length;
            }, 1000);
        } else {
            showToast('Error: ' + (result?.error || 'Failed'), 'error');
        }
    } catch(e) {
        console.error(e);
        showToast('Error: ' + e.message, 'error');
    }
    
    btn.disabled = false;
    btn.innerHTML = 'Submit Visit';
}

// ============ ADMIN PANEL ============
function toggleAdmin() {
    const panel = document.getElementById('admin-panel');
    const overlay = document.getElementById('admin-overlay');
    
    // If opening and not unlocked, prompt for PIN
    if (!panel.classList.contains('open') && !isAdminUnlocked) {
        const pin = prompt('Enter Admin PIN:');
        if (pin !== CONFIG.ADMIN_PIN) {
            if (pin !== null) showToast('Incorrect PIN', 'error');
            return;
        }
        isAdminUnlocked = true;
    }
    
    panel.classList.toggle('open');
    overlay.classList.toggle('open');
}

function showAdminTab(tab, btn) {
    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('admin-' + tab).classList.add('active');
    
    if (tab === 'add') {
        // Reset form for new field
        document.getElementById('edit-field-id').value = '';
        document.getElementById('field-form-title').textContent = '+ Add Field';
        document.getElementById('field-label').value = '';
        document.getElementById('field-type').value = 'text';
        document.getElementById('field-options').value = '';
        document.getElementById('field-section').value = 'products';
        toggleOptionsRow();
    }
}

function renderFieldConfigList() {
    const container = document.getElementById('field-config-list');
    
    // Group by section
    const grouped = {};
    fieldConfig.forEach(f => {
        if (!grouped[f.section]) grouped[f.section] = [];
        grouped[f.section].push(f);
    });
    
    container.innerHTML = Object.entries(grouped).map(([section, fields]) => {
        const m = sectionMeta[section] || { icon: 'üìã', title: section };
        return `
            <div class="section-group">
                <div class="section-group-title">${m.icon} ${m.title}</div>
                ${fields.map(f => `
                    <div class="field-config-item">
                        <div class="field-config-top">
                            <div>
                                <div class="field-config-name">${f.label}</div>
                                <div class="field-config-meta">${f.type}${f.options?.length ? ` ‚Ä¢ ${f.options.length} options` : ''}</div>
                            </div>
                            <div class="field-config-actions">
                                <button class="field-action-btn edit" onclick="editField('${f.id}')" title="Edit">‚úèÔ∏è</button>
                                <button class="field-action-btn delete" onclick="deleteField('${f.id}')" title="Delete">üóëÔ∏è</button>
                                <button class="field-action-btn toggle ${f.active ? 'active' : ''}" onclick="toggleFieldActive('${f.id}')" title="Toggle">
                                    ${f.active ? '‚úì' : '‚óã'}
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }).join('');
}

function toggleFieldActive(id) {
    const f = fieldConfig.find(x => x.id === id);
    if (f) {
        f.active = !f.active;
        renderFieldConfigList();
        saveConfigToServer();
        showToast(`${f.label} ${f.active ? 'enabled' : 'disabled'}`);
    }
}

function editField(id) {
    const f = fieldConfig.find(x => x.id === id);
    if (!f) return;
    
    document.getElementById('edit-field-id').value = id;
    document.getElementById('field-form-title').textContent = '‚úèÔ∏è Edit Field';
    document.getElementById('field-label').value = f.label;
    document.getElementById('field-type').value = f.type;
    document.getElementById('field-options').value = (f.options || []).join(', ');
    document.getElementById('field-section').value = f.section;
    toggleOptionsRow();
    
    showAdminTab('add', document.querySelectorAll('.admin-tab')[1]);
}

function deleteField(id) {
    const f = fieldConfig.find(x => x.id === id);
    if (!f) return;
    
    deleteFieldId = id;
    document.getElementById('confirm-message').textContent = `Delete "${f.label}"? This won't remove existing data.`;
    document.getElementById('confirm-dialog').classList.add('open');
}

function closeConfirm() {
    document.getElementById('confirm-dialog').classList.remove('open');
    deleteFieldId = null;
}

function confirmDelete() {
    if (deleteFieldId) {
        fieldConfig = fieldConfig.filter(f => f.id !== deleteFieldId);
        renderFieldConfigList();
        saveConfigToServer();
        showToast('Field deleted');
    }
    closeConfirm();
}

function toggleOptionsRow() {
    const type = document.getElementById('field-type').value;
    document.getElementById('options-row').style.display = ['select', 'multiselect'].includes(type) ? 'block' : 'none';
}

function cancelFieldEdit() {
    showAdminTab('fields', document.querySelectorAll('.admin-tab')[0]);
}

function saveField() {
    const editId = document.getElementById('edit-field-id').value;
    const label = document.getElementById('field-label').value.trim();
    const type = document.getElementById('field-type').value;
    const section = document.getElementById('field-section').value;
    const optionsStr = document.getElementById('field-options').value.trim();
    
    if (!label) {
        showToast('Enter a label', 'error');
        return;
    }
    
    const id = editId || label.toLowerCase().replace(/[^a-z0-9]+/g, '_');
    const options = optionsStr ? optionsStr.split(',').map(o => o.trim()).filter(o => o) : [];
    
    if (editId) {
        // Update existing
        const f = fieldConfig.find(x => x.id === editId);
        if (f) {
            f.label = label;
            f.type = type;
            f.section = section;
            f.options = options.length ? options : undefined;
        }
    } else {
        // Check for duplicate
        if (fieldConfig.find(f => f.id === id)) {
            showToast('Field already exists', 'error');
            return;
        }
        
        // Add new
        fieldConfig.push({
            id,
            label,
            type,
            section,
            active: true,
            options: options.length ? options : undefined
        });
    }
    
    renderFieldConfigList();
    saveConfigToServer();
    showToast(editId ? 'Field updated' : 'Field added', 'success');
    showAdminTab('fields', document.querySelectorAll('.admin-tab')[0]);
}

async function saveConfigToServer() {
    try {
        await apiPost('saveConfig', { fields: fieldConfig });
    } catch(e) {
        console.error('Failed to save config:', e);
    }
}

// ============ UTILITIES ============
function showToast(msg, type) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'toast ' + (type || '') + ' show';
    setTimeout(() => t.classList.remove('show'), 3000);
}

// Close modals on background click
document.getElementById('visit-modal').onclick = e => { if (e.target.id === 'visit-modal') closeModal(); };
</script>
</body>
</html>
