<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a1a1a">
    <title>IVG Store Visit</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root { --ivg-red: #E31937; --ivg-red-dark: #B8152C; --ivg-black: #1a1a1a; --bg-light: #f5f5f5; --text-primary: #1a1a1a; --text-secondary: #666; --border-color: #e0e0e0; --success: #22c55e; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0; background: var(--bg-light); color: var(--text-primary); min-height: 100vh; }
        .header { background: var(--ivg-black); padding: 12px 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .header-content { display: flex; align-items: center; justify-content: space-between; max-width: 600px; margin: 0 auto; }
        .logo-wrap { display: flex; align-items: center; gap: 8px; }
        .admin-btn { background: var(--ivg-red); border: none; color: white; padding: 10px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; }
        .container { max-width: 600px; margin: 0 auto; padding: 16px; }
        .screen { display: none; }
        .screen.active { display: block; }
        .stats-banner { display: flex; gap: 12px; margin-bottom: 16px; }
        .stat-card { flex: 1; background: white; padding: 16px; border-radius: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .stat-card .number { font-size: 28px; font-weight: 700; color: var(--ivg-red); }
        .stat-card .label { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
        .search-box { position: relative; margin-bottom: 16px; }
        .search-input { width: 100%; padding: 16px 16px 16px 48px; font-size: 16px; border: 2px solid var(--border-color); border-radius: 12px; background: white; outline: none; }
        .search-input:focus { border-color: var(--ivg-red); }
        .search-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #999; }
        .store-list { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .store-item { padding: 16px; border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .store-item:last-child { border-bottom: none; }
        .store-item:active { background: #fef2f2; }
        .store-info h3 { margin: 0 0 4px 0; font-size: 16px; }
        .store-info p { margin: 0; font-size: 13px; color: var(--text-secondary); }
        .store-meta { text-align: right; }
        .store-code { background: var(--ivg-red); color: white; padding: 6px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; font-family: monospace; display: inline-block; }
        .store-visits { font-size: 11px; color: var(--text-secondary); margin-top: 6px; }
        .new-store-btn, .submit-btn { width: 100%; padding: 18px; background: var(--ivg-red); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .new-store-btn { margin-top: 16px; }
        .back-btn { display: flex; align-items: center; gap: 6px; color: var(--text-secondary); background: none; border: none; padding: 8px 0; font-size: 14px; cursor: pointer; margin-bottom: 12px; }
        .store-info-card { background: linear-gradient(135deg, #1a1a1a, #333); color: white; padding: 20px; border-radius: 12px; margin-bottom: 16px; }
        .store-info-card h2 { margin: 0 0 4px 0; font-size: 20px; }
        .store-info-card .code { font-family: monospace; background: var(--ivg-red); padding: 4px 8px; border-radius: 4px; font-size: 12px; display: inline-block; margin-bottom: 12px; }
        .store-info-card .details { font-size: 13px; opacity: 0.8; }
        .store-info-card .visit-count { margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.2); font-size: 12px; display: flex; justify-content: space-between; }
        .visit-history { background: white; border-radius: 12px; margin-bottom: 16px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .history-header { background: #f0f0f0; padding: 12px 16px; font-weight: 600; font-size: 14px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .history-list { max-height: 200px; overflow-y: auto; }
        .history-list.collapsed { display: none; }
        .history-item { padding: 12px 16px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
        .history-item:last-child { border-bottom: none; }
        .history-item .date { font-weight: 600; }
        .history-item .summary { color: var(--text-secondary); font-size: 12px; }
        .history-item .view-btn { background: none; border: 1px solid var(--ivg-red); color: var(--ivg-red); padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; }
        .history-badge { background: var(--ivg-red); color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; }
        .prefill-notice { background: #e8f5e9; border: 1px solid #a5d6a7; border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; font-size: 13px; color: #2e7d32; display: flex; align-items: center; gap: 10px; }
        .form-section { background: white; border-radius: 12px; margin-bottom: 16px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .section-header { background: linear-gradient(135deg, var(--ivg-red), var(--ivg-red-dark)); color: white; padding: 14px 16px; font-weight: 600; font-size: 14px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .section-header.collapsed .toggle-icon { transform: rotate(-90deg); }
        .toggle-icon { transition: transform 0.3s; }
        .section-content { padding: 16px; }
        .section-content.collapsed { display: none; }
        .field-group { margin-bottom: 16px; }
        .field-group:last-child { margin-bottom: 0; }
        .field-label { display: block; font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; }
        .field-label.required::after { content: ' *'; color: var(--ivg-red); }
        .text-input, .select-input, .textarea-input { width: 100%; padding: 12px 14px; font-size: 16px; border: 2px solid var(--border-color); border-radius: 8px; background: white; outline: none; }
        .text-input:focus, .select-input:focus { border-color: var(--ivg-red); }
        .textarea-input { min-height: 100px; resize: vertical; }
        .toggle-group { display: flex; gap: 8px; }
        .toggle-btn { padding: 10px 20px; border: 2px solid var(--border-color); border-radius: 8px; background: white; font-size: 14px; font-weight: 500; cursor: pointer; flex: 1; text-align: center; }
        .toggle-btn.yes.active { background: var(--success); border-color: var(--success); color: white; }
        .toggle-btn.no.active { background: #ef4444; border-color: #ef4444; color: white; }
        .checkbox-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; padding: 10px 12px; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; font-size: 13px; user-select: none; }
        .checkbox-item.checked { background: #fef2f2; border-color: var(--ivg-red); }
        .checkbox-box { width: 20px; height: 20px; border: 2px solid var(--border-color); border-radius: 4px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .checkbox-item.checked .checkbox-box { background: var(--ivg-red); border-color: var(--ivg-red); }
        .checkbox-box svg { opacity: 0; }
        .checkbox-item.checked .checkbox-box svg { opacity: 1; }
        .conditional-field { display: none; margin-top: 12px; padding-top: 12px; border-top: 1px dashed var(--border-color); }
        .conditional-field.visible { display: block; }
        .photo-section { background: white; border-radius: 12px; margin-bottom: 16px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .photo-header { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; padding: 14px 16px; font-weight: 600; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
        .photo-count-badge { background: white; color: #2563eb; padding: 2px 10px; border-radius: 10px; font-size: 12px; }
        .photo-content { padding: 16px; }
        .photo-upload-area { border: 2px dashed var(--border-color); border-radius: 12px; padding: 30px 24px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .photo-upload-area:hover, .photo-upload-area:active { border-color: #2563eb; background: #eff6ff; }
        .photo-upload-area .icon { font-size: 40px; margin-bottom: 8px; }
        .photo-upload-area .text { font-size: 14px; color: var(--text-secondary); }
        .photo-preview-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 16px; }
        .photo-preview { position: relative; aspect-ratio: 1; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        .photo-preview img { width: 100%; height: 100%; object-fit: cover; }
        .photo-remove { position: absolute; top: 6px; right: 6px; width: 26px; height: 26px; background: rgba(239,68,68,0.9); border: none; border-radius: 50%; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .photo-note { font-size: 11px; color: #666; text-align: center; margin-top: 8px; }
        .submit-section { position: sticky; bottom: 0; background: linear-gradient(to top, var(--bg-light) 80%, transparent); padding: 16px 0 24px; margin-top: 16px; }
        .submit-note { text-align: center; font-size: 12px; color: var(--text-secondary); margin-bottom: 12px; }
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--ivg-black); color: white; padding: 14px 24px; border-radius: 12px; font-size: 14px; opacity: 0; transition: all 0.3s; z-index: 1000; max-width: 90%; text-align: center; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: var(--success); }
        .toast.error { background: #ef4444; }
        .spinner { width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: flex; align-items: center; justify-content: center; z-index: 500; flex-direction: column; gap: 16px; }
        .loading-overlay .spinner { width: 40px; height: 40px; border-width: 3px; border-color: var(--ivg-red); border-top-color: transparent; }
        .admin-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 199; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .admin-overlay.open { opacity: 1; visibility: visible; }
        .admin-panel { position: fixed; top: 0; right: -100%; width: 100%; max-width: 420px; height: 100%; background: white; z-index: 200; transition: right 0.3s; overflow-y: auto; }
        .admin-panel.open { right: 0; }
        .admin-header { background: var(--ivg-black); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; }
        .admin-header h2 { margin: 0; font-size: 18px; }
        .admin-close { background: none; border: none; color: white; cursor: pointer; padding: 8px; font-size: 20px; }
        .admin-content { padding: 20px; }
        .admin-tabs { display: flex; gap: 8px; margin-bottom: 20px; }
        .admin-tab { flex: 1; padding: 12px; border: 2px solid var(--border-color); background: white; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; }
        .admin-tab.active { background: var(--ivg-red); border-color: var(--ivg-red); color: white; }
        .admin-section { display: none; }
        .admin-section.active { display: block; }
        .field-config-item { display: flex; align-items: center; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid var(--border-color); }
        .field-config-item .field-info { flex: 1; }
        .field-config-item .field-name { font-size: 14px; font-weight: 500; }
        .field-config-item .field-meta { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
        .field-toggle { width: 48px; height: 28px; background: #e0e0e0; border-radius: 14px; cursor: pointer; position: relative; flex-shrink: 0; }
        .field-toggle.active { background: var(--success); }
        .field-toggle::after { content: ''; position: absolute; width: 24px; height: 24px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: left 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .field-toggle.active::after { left: 22px; }
        .add-field-form { background: #f9f9f9; border-radius: 12px; padding: 20px; }
        .add-field-form h3 { margin: 0 0 16px 0; font-size: 16px; color: var(--ivg-red); }
        .form-row { margin-bottom: 14px; }
        .form-row label { display: block; font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; }
        .form-row input, .form-row select { width: 100%; padding: 10px 12px; font-size: 14px; border: 2px solid var(--border-color); border-radius: 8px; background: white; outline: none; }
        .add-field-btn { width: 100%; padding: 12px; background: var(--ivg-red); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; margin-top: 16px; }
        .section-group { margin-bottom: 24px; }
        .section-group-title { font-size: 12px; font-weight: 700; color: var(--ivg-red); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 2px solid var(--ivg-red); }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
        .empty-state h3 { margin: 16px 0 8px; color: var(--text-primary); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 300; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-overlay.open { display: flex; }
        .modal-content { background: white; border-radius: 12px; max-width: 500px; width: 100%; max-height: 80vh; overflow-y: auto; }
        .modal-header { background: var(--ivg-black); color: white; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; }
        .modal-header h3 { margin: 0; font-size: 16px; }
        .modal-close { background: none; border: none; color: white; font-size: 20px; cursor: pointer; }
        .modal-body { padding: 20px; }
        .modal-body .detail-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-color); font-size: 14px; }
        .modal-body .detail-label { color: var(--text-secondary); }
        .modal-body .detail-value { font-weight: 500; text-align: right; max-width: 60%; }
        .modal-photos { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 16px; }
        .modal-photos a { display: block; border-radius: 8px; overflow: hidden; }
        .modal-photos img { width: 100%; aspect-ratio: 1; object-fit: cover; }
        .offline-banner { background: #f59e0b; color: white; text-align: center; padding: 8px; font-size: 12px; display: none; }
        .offline-banner.show { display: block; }
    </style>
</head>
<body>
    <div class="offline-banner" id="offline-banner">‚ö†Ô∏è Offline - data won't save</div>
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
        <div>Loading...</div>
    </div>
    
    <header class="header">
        <div class="header-content">
            <div class="logo-wrap">
                <span style="font-size: 24px; font-weight: 900; color: white;">IVG</span>
                <span style="font-size: 24px; font-weight: 900; color: #E31937;">STORE VISIT</span>
            </div>
            <button class="admin-btn" onclick="toggleAdmin()">‚öôÔ∏è</button>
        </div>
    </header>
    
    <div class="container">
        <div id="screen-select" class="screen active">
            <div class="stats-banner">
                <div class="stat-card"><div class="number" id="total-stores">0</div><div class="label">Stores</div></div>
                <div class="stat-card"><div class="number" id="total-visits">0</div><div class="label">Visits</div></div>
            </div>
            <div class="search-box">
                <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="M21 21l-4.35-4.35"></path></svg>
                <input type="text" class="search-input" id="store-search" placeholder="Search stores...">
            </div>
            <div class="store-list" id="store-list"></div>
            <button class="new-store-btn" onclick="startNewStore()">+ Add New Store</button>
        </div>
        
        <div id="screen-form" class="screen">
            <button class="back-btn" onclick="showScreen('select')">‚Üê Back</button>
            <div class="store-info-card" id="store-card" style="display:none;">
                <span class="code" id="card-code"></span>
                <h2 id="card-name"></h2>
                <div class="details" id="card-details"></div>
                <div class="visit-count"><span id="card-visit-count"></span><span id="card-last-visit"></span></div>
            </div>
            <div class="visit-history" id="visit-history" style="display:none;">
                <div class="history-header" onclick="toggleHistory()"><span>üìÖ History</span><span class="history-badge" id="history-count">0</span></div>
                <div class="history-list" id="history-list"></div>
            </div>
            <div class="prefill-notice" id="prefill-notice" style="display:none;">‚úì Pre-filled from last visit</div>
            <div id="form-sections-container"></div>
            <div class="photo-section">
                <div class="photo-header"><span>üì∏ Photos</span><span class="photo-count-badge" id="photo-count-badge">0</span></div>
                <div class="photo-content">
                    <div class="photo-upload-area" onclick="document.getElementById('photo-input').click()">
                        <div class="icon">üì∑</div>
                        <div class="text">Tap to add photos</div>
                    </div>
                    <input type="file" id="photo-input" accept="image/*" capture="environment" multiple style="display:none" onchange="handlePhotos(this)">
                    <div class="photo-preview-grid" id="photo-previews"></div>
                    <div class="photo-note" id="photo-note"></div>
                </div>
            </div>
            <div class="submit-section">
                <div class="submit-note" id="submit-note"></div>
                <button class="submit-btn" id="submit-btn" onclick="submitVisit()">Submit Visit</button>
            </div>
        </div>
    </div>
    
    <div class="admin-overlay" id="admin-overlay" onclick="toggleAdmin()"></div>
    <div class="admin-panel" id="admin-panel">
        <div class="admin-header"><h2>Settings</h2><button class="admin-close" onclick="toggleAdmin()">‚úï</button></div>
        <div class="admin-content">
            <div class="admin-tabs">
                <button class="admin-tab active" onclick="showAdminTab('manage',this)">Fields</button>
                <button class="admin-tab" onclick="showAdminTab('add',this)">Add</button>
            </div>
            <div id="admin-manage" class="admin-section active"><div id="field-config-list"></div></div>
            <div id="admin-add" class="admin-section">
                <div class="add-field-form">
                    <h3>+ New Field</h3>
                    <div class="form-row"><label>Label</label><input type="text" id="new-field-label"></div>
                    <div class="form-row"><label>Type</label><select id="new-field-type" onchange="toggleOptionsField()"><option value="text">Text</option><option value="number">Number</option><option value="yesno">Yes/No</option><option value="select">Dropdown</option><option value="multiselect">Multi</option><option value="textarea">Notes</option></select></div>
                    <div class="form-row" id="options-row" style="display:none;"><label>Options</label><input type="text" id="new-field-options" placeholder="A, B, C"></div>
                    <div class="form-row"><label>Section</label><select id="new-field-section"><option value="products">Products</option><option value="gantry">Gantry</option><option value="sales">Sales</option><option value="orders">Orders</option><option value="pos">POS</option><option value="competitors">Competitors</option><option value="notes">Notes</option></select></div>
                    <button class="add-field-btn" onclick="addNewField()">Add</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="visit-modal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="modal-title">Visit</h3><button class="modal-close" onclick="closeModal()">‚úï</button></div>
            <div class="modal-body" id="modal-body"></div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>

<script>
// CONFIG
const API_URL = 'https://script.google.com/macros/s/AKfycbw2d7I-4vXphPa-rftpaqHGPfuqVmkQOemIEZv3NMOeYJdC4thuqGCFnFdsn86bfPOdjg/exec';

// STATE
let currentStore = null, isNewStore = false, lastVisitData = null, photos = [], formData = {}, stores = [], visits = [];

let fieldConfig = [
    { id: 'business_name', label: 'Business Name', type: 'text', section: 'business', required: true, active: true },
    { id: 'business_type', label: 'Business Type', type: 'select', section: 'business', required: true, active: true, options: ['Vape Store','Vape Chain','FMCG','Wholesaler','Convenience','Phone Repair'] },
    { id: 'address', label: 'Address', type: 'text', section: 'business', required: true, active: true },
    { id: 'postcode', label: 'Post Code', type: 'text', section: 'business', required: false, active: true },
    { id: 'store_location', label: 'Town/Area', type: 'text', section: 'business', required: false, active: true },
    { id: 'contact', label: 'Contact', type: 'text', section: 'business', required: false, active: true },
    { id: 'phone', label: 'Phone', type: 'text', section: 'business', required: false, active: true },
    { id: 'email', label: 'Email', type: 'text', section: 'business', required: false, active: true },
    { id: 'main_supplier', label: 'Main Supplier', type: 'select', section: 'business', required: true, active: true, options: ['HALE','CLAYTON','E-CIRETTE','JFC','NEWVEND','CHINMARA','UK WHOLESALE','FLEMING','SMOKEGREEN','AMPERSAND','KADONA','OTHER'] },
    { id: 'has_ivg2400', label: 'Has IVG 2400?', type: 'yesno', section: 'products', required: true, active: true },
    { id: 'ivg2400_sku', label: '2400 SKU Count', type: 'number', section: 'products', required: false, active: true, showIf: { field: 'has_ivg2400', value: 'YES' } },
    { id: 'has_smart5500', label: 'Has SMART 5500?', type: 'yesno', section: 'products', required: true, active: true },
    { id: 'has_pro12', label: 'Has PRO-12?', type: 'yesno', section: 'products', required: true, active: true },
    { id: 'has_savr', label: 'Has IVG SAVR?', type: 'yesno', section: 'products', required: true, active: true },
    { id: 'has_10ml_salts', label: 'Has 10ML Salts?', type: 'yesno', section: 'products', required: false, active: true },
    { id: 'gantry_share', label: 'Gantry % IVG', type: 'number', section: 'gantry', required: true, active: true },
    { id: 'ivg2400_units_wide', label: '2400 Units Wide', type: 'number', section: 'gantry', required: false, active: true },
    { id: 'ivg2400_placement', label: '2400 Placement', type: 'multiselect', section: 'gantry', required: false, active: true, options: ['Counter','Eye Level','Top','Middle','Bottom'] },
    { id: 'devices_daily_sales', label: 'Devices/Day', type: 'number', section: 'sales', required: false, active: true },
    { id: 'order_placed', label: 'Order Placed?', type: 'yesno', section: 'orders', required: true, active: true },
    { id: 'devices_order_frequency', label: 'Order Frequency', type: 'select', section: 'orders', required: false, active: true, options: ['DAILY','WEEKLY','10 DAYS','14 DAYS','30 DAYS'] },
    { id: 'pos_allowed', label: 'POS Allowed?', type: 'yesno', section: 'pos', required: false, active: true },
    { id: 'brand_pos_required', label: 'POS Needed', type: 'multiselect', section: 'pos', required: false, active: true, options: ['Door Signs','Floor Mats','Counter Mats','Shelf Strips','Wobblers'] },
    { id: 'devices_competitor1', label: 'Top Competitor', type: 'select', section: 'competitors', required: false, active: true, options: ['LOST MARY','VUSE','ELF BAR','HAYATTI','SKE','GOLD BAR'] },
    { id: 'notes', label: 'Notes', type: 'textarea', section: 'notes', required: false, active: true },
];

const sectionMeta = {
    business: { icon: 'üìç', title: 'Business', defaultOpen: true },
    products: { icon: 'üì¶', title: 'Products', defaultOpen: true },
    gantry: { icon: 'üóÑÔ∏è', title: 'Gantry', defaultOpen: false },
    sales: { icon: 'üìä', title: 'Sales', defaultOpen: false },
    orders: { icon: 'üõí', title: 'Orders', defaultOpen: false },
    pos: { icon: 'üè∑Ô∏è', title: 'POS', defaultOpen: false },
    competitors: { icon: 'üèÜ', title: 'Competitors', defaultOpen: false },
    notes: { icon: 'üìù', title: 'Notes', defaultOpen: true },
};

// API - no photos in URL, photos uploaded separately
async function apiCall(action, data = null) {
    try {
        let url = API_URL + '?action=' + action;
        if (data) {
            // Remove photos from URL data - they'll be uploaded separately
            const urlData = { ...data };
            delete urlData.photos;
            url += '&data=' + encodeURIComponent(JSON.stringify(urlData));
        }
        const r = await fetch(url);
        return await r.json();
    } catch (e) {
        console.error('API Error:', e);
        return null;
    }
}

// Upload single photo
async function uploadPhoto(storeCode, photoData) {
    try {
        const url = API_URL + '?action=uploadPhoto&data=' + encodeURIComponent(JSON.stringify({
            storeCode: storeCode,
            photoData: photoData
        }));
        const r = await fetch(url);
        return await r.json();
    } catch (e) {
        console.error('Photo upload error:', e);
        return { success: false };
    }
}

// INIT
document.addEventListener('DOMContentLoaded', async () => {
    if (!navigator.onLine) document.getElementById('offline-banner').classList.add('show');
    window.addEventListener('online', () => document.getElementById('offline-banner').classList.remove('show'));
    window.addEventListener('offline', () => document.getElementById('offline-banner').classList.add('show'));
    await loadData();
    document.getElementById('loading-overlay').style.display = 'none';
    renderFieldConfigList();
});

async function loadData() {
    const [storesRes, visitsRes, statsRes] = await Promise.all([
        apiCall('getStores'),
        apiCall('getVisits'),
        apiCall('getStats')
    ]);
    if (storesRes?.stores) stores = storesRes.stores;
    if (visitsRes?.visits) visits = visitsRes.visits;
    document.getElementById('total-stores').textContent = statsRes?.totalStores || stores.length;
    document.getElementById('total-visits').textContent = statsRes?.totalVisits || visits.length;
    renderStoreList();
}

// HELPERS
function getStoreVisits(code) { return visits.filter(v => v.store_code === code).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); }
function getLatestVisit(code) { const v = getStoreVisits(code); return v[0] || null; }
function formatDate(d) { return new Date(d).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }); }
function formatDateTime(d) { return new Date(d).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }); }

// STORE LIST
function renderStoreList(filter = '') {
    const list = document.getElementById('store-list');
    const filtered = stores.filter(s => (s.name || '').toLowerCase().includes(filter.toLowerCase()) || (s.code || '').toLowerCase().includes(filter.toLowerCase()));
    if (!filtered.length) { list.innerHTML = '<div class="empty-state"><h3>No stores</h3></div>'; return; }
    list.innerHTML = filtered.map(s => {
        const sv = getStoreVisits(s.code);
        return '<div class="store-item" onclick="selectStore(\'' + s.code + '\')"><div class="store-info"><h3>' + s.name + '</h3><p>' + (s.location || '') + '</p></div><div class="store-meta"><span class="store-code">' + s.code + '</span><div class="store-visits">' + sv.length + ' visits</div></div></div>';
    }).join('');
}
document.getElementById('store-search').addEventListener('input', e => renderStoreList(e.target.value));

// SELECT STORE
function selectStore(code) {
    currentStore = stores.find(s => s.code === code);
    isNewStore = false;
    const sv = getStoreVisits(code);
    lastVisitData = getLatestVisit(code);
    document.getElementById('store-card').style.display = 'block';
    document.getElementById('card-code').textContent = currentStore.code;
    document.getElementById('card-name').textContent = currentStore.name;
    document.getElementById('card-details').textContent = (currentStore.location || '') + ' ‚Ä¢ ' + (currentStore.type || '');
    document.getElementById('card-visit-count').textContent = sv.length + ' visits';
    document.getElementById('card-last-visit').textContent = lastVisitData ? 'Last: ' + formatDate(lastVisitData.timestamp) : '';
    renderVisitHistory(sv);
    document.getElementById('prefill-notice').style.display = lastVisitData ? 'flex' : 'none';
    document.getElementById('submit-note').textContent = 'Create visit #' + (sv.length + 1);
    renderForm(false);
    prefillForm(lastVisitData);
    photos = [];
    updatePhotoUI();
    showScreen('form');
}

function renderVisitHistory(sv) {
    const c = document.getElementById('visit-history');
    if (!sv.length) { c.style.display = 'none'; return; }
    c.style.display = 'block';
    document.getElementById('history-count').textContent = sv.length;
    document.getElementById('history-list').innerHTML = sv.map((v, i) => {
        const sum = [];
        if (v.has_ivg2400 === 'YES') sum.push('2400');
        if (v.has_pro12 === 'YES') sum.push('PRO');
        if (v.order_placed === 'YES') sum.push('üì¶');
        if (parseInt(v.photo_count) > 0) sum.push('üì∑' + v.photo_count);
        return '<div class="history-item"><div><div class="date">' + formatDateTime(v.timestamp) + '</div><div class="summary">' + (sum.join(' ') || '-') + '</div></div><button class="view-btn" onclick="viewVisit(' + i + ')">View</button></div>';
    }).join('');
}

function toggleHistory() { document.getElementById('history-list').classList.toggle('collapsed'); }

function viewVisit(i) {
    const sv = getStoreVisits(currentStore.code);
    const v = sv[i];
    document.getElementById('modal-title').textContent = formatDateTime(v.timestamp);
    let html = '';
    fieldConfig.forEach(f => { if (f.section !== 'business' && v[f.id]) html += '<div class="detail-row"><span class="detail-label">' + f.label + '</span><span class="detail-value">' + v[f.id] + '</span></div>'; });
    if (v.photo_links) {
        const links = v.photo_links.split(' | ').filter(l => l.trim());
        if (links.length) {
            html += '<div style="margin-top:16px;font-weight:600;">üì∑ Photos</div><div class="modal-photos">' + links.map(link => {
                const id = link.match(/\/d\/([^\/]+)/)?.[1] || '';
                return '<a href="' + link + '" target="_blank"><img src="https://drive.google.com/thumbnail?id=' + id + '&sz=w200"></a>';
            }).join('') + '</div>';
        }
    }
    document.getElementById('modal-body').innerHTML = html || '<p>No data</p>';
    document.getElementById('visit-modal').classList.add('open');
}
function closeModal() { document.getElementById('visit-modal').classList.remove('open'); }

function startNewStore() {
    currentStore = null; isNewStore = true; lastVisitData = null;
    document.getElementById('store-card').style.display = 'none';
    document.getElementById('visit-history').style.display = 'none';
    document.getElementById('prefill-notice').style.display = 'none';
    document.getElementById('submit-note').textContent = 'Create new store';
    clearForm(); photos = []; updatePhotoUI(); renderForm(true); showScreen('form');
}

function showScreen(s) {
    document.querySelectorAll('.screen').forEach(x => x.classList.remove('active'));
    document.getElementById('screen-' + s).classList.add('active');
    if (s === 'select') { document.getElementById('store-search').value = ''; renderStoreList(); }
}

// FORM
function renderForm(showBusiness) {
    const c = document.getElementById('form-sections-container');
    c.innerHTML = '';
    const sections = {};
    fieldConfig.filter(f => f.active).forEach(f => { if (!sections[f.section]) sections[f.section] = []; sections[f.section].push(f); });
    Object.entries(sections).forEach(([sid, fields]) => {
        if (sid === 'business' && !showBusiness) return;
        const m = sectionMeta[sid] || { icon: 'üìã', title: sid, defaultOpen: false };
        c.innerHTML += '<div class="form-section"><div class="section-header ' + (m.defaultOpen ? '' : 'collapsed') + '" onclick="toggleSection(this)"><span>' + m.icon + ' ' + m.title + '</span><svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg></div><div class="section-content ' + (m.defaultOpen ? '' : 'collapsed') + '">' + fields.map(renderField).join('') + '</div></div>';
    });
    setupFormListeners();
}

function renderField(f) {
    const cond = f.showIf ? 'conditional-field" data-show-if="' + f.showIf.field + '" data-show-value="' + f.showIf.value : '';
    const req = f.required ? 'required' : '';
    let inp = '';
    if (f.type === 'text' || f.type === 'number') inp = '<input type="' + f.type + '" class="text-input" id="' + f.id + '">';
    else if (f.type === 'textarea') inp = '<textarea class="textarea-input" id="' + f.id + '"></textarea>';
    else if (f.type === 'select') inp = '<select class="select-input" id="' + f.id + '"><option value="">Select...</option>' + (f.options || []).map(o => '<option value="' + o + '">' + o + '</option>').join('') + '</select>';
    else if (f.type === 'yesno') inp = '<div class="toggle-group"><button type="button" class="toggle-btn yes" data-field="' + f.id + '" data-value="YES">YES</button><button type="button" class="toggle-btn no" data-field="' + f.id + '" data-value="NO">NO</button></div>';
    else if (f.type === 'multiselect') inp = '<div class="checkbox-grid" data-field="' + f.id + '">' + (f.options || []).map(o => '<div class="checkbox-item" data-value="' + o + '"><span class="checkbox-box"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></span><span>' + o + '</span></div>').join('') + '</div>';
    return '<div class="field-group ' + cond + '"><label class="field-label ' + req + '">' + f.label + '</label>' + inp + '</div>';
}

function setupFormListeners() {
    document.querySelectorAll('.toggle-btn').forEach(b => b.addEventListener('click', () => {
        b.parentElement.querySelectorAll('.toggle-btn').forEach(x => x.classList.remove('active'));
        b.classList.add('active');
        formData[b.dataset.field] = b.dataset.value;
        document.querySelectorAll('[data-show-if="' + b.dataset.field + '"]').forEach(el => el.classList.toggle('visible', el.dataset.showValue === b.dataset.value));
    }));
    
    // Fixed checkbox handler
    document.querySelectorAll('.checkbox-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.toggle('checked');
        });
    });
}

function prefillForm(v) {
    if (!v) return;
    formData = { ...v };
    fieldConfig.forEach(f => {
        const val = v[f.id]; if (!val) return;
        const el = document.getElementById(f.id);
        if (['text','number','textarea','select'].includes(f.type) && el) el.value = val;
        else if (f.type === 'yesno') {
            const btn = document.querySelector('[data-field="' + f.id + '"][data-value="' + val + '"]');
            if (btn) { btn.parentElement.querySelectorAll('.toggle-btn').forEach(x => x.classList.remove('active')); btn.classList.add('active'); }
            document.querySelectorAll('[data-show-if="' + f.id + '"]').forEach(el => el.classList.toggle('visible', el.dataset.showValue === val));
        } else if (f.type === 'multiselect' && val) {
            const vals = val.split(', ');
            const grid = document.querySelector('[data-field="' + f.id + '"]');
            if (grid) grid.querySelectorAll('.checkbox-item').forEach(item => {
                if (vals.includes(item.dataset.value)) {
                    item.classList.add('checked');
                }
            });
        }
    });
}

function toggleSection(h) { h.classList.toggle('collapsed'); h.nextElementSibling.classList.toggle('collapsed'); }

// PHOTOS - more aggressive compression
function handlePhotos(input) {
    Array.from(input.files).forEach(file => {
        const r = new FileReader();
        r.onload = e => {
            // Compress to 600px max, 50% quality
            compressImage(e.target.result, 600, 0.5, compressed => {
                photos.push({ data: compressed });
                updatePhotoUI();
            });
        };
        r.readAsDataURL(file);
    });
    input.value = '';
}

function compressImage(dataUrl, maxW, quality, cb) {
    const img = new Image();
    img.onload = () => {
        const canvas = document.createElement('canvas');
        let w = img.width, h = img.height;
        if (w > maxW) { h = (maxW / w) * h; w = maxW; }
        if (h > maxW) { w = (maxW / h) * w; h = maxW; }
        canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        cb(canvas.toDataURL('image/jpeg', quality));
    };
    img.src = dataUrl;
}

function updatePhotoUI() {
    document.getElementById('photo-count-badge').textContent = photos.length;
    document.getElementById('photo-previews').innerHTML = photos.map((p, i) => '<div class="photo-preview"><img src="' + p.data + '"><button class="photo-remove" onclick="removePhoto(' + i + ')">‚úï</button></div>').join('');
    document.getElementById('photo-note').textContent = photos.length ? photos.length + ' photo(s) ready' : '';
}

function removePhoto(i) {
    photos.splice(i, 1);
    updatePhotoUI();
}

// SUBMIT - form first, then photos one by one
function collectFormData() {
    const data = { ...formData };
    document.querySelectorAll('.text-input, .textarea-input, .select-input').forEach(inp => { if (inp.id) data[inp.id] = inp.value; });
    
    // Fixed multiselect collection
    document.querySelectorAll('.checkbox-grid').forEach(grid => {
        const checked = Array.from(grid.querySelectorAll('.checkbox-item.checked')).map(item => item.dataset.value);
        data[grid.dataset.field] = checked.join(', ');
    });
    
    data.timestamp = new Date().toISOString();
    return data;
}

function clearForm() {
    formData = {};
    document.querySelectorAll('.text-input, .textarea-input').forEach(el => el.value = '');
    document.querySelectorAll('.select-input').forEach(el => el.selectedIndex = 0);
    document.querySelectorAll('.toggle-btn').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.checkbox-item').forEach(el => el.classList.remove('checked'));
    document.querySelectorAll('.conditional-field').forEach(el => el.classList.remove('visible'));
}

async function submitVisit() {
    const btn = document.getElementById('submit-btn');
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner"></div> Saving...';
    
    const data = collectFormData();
    data.is_new_store = isNewStore;
    if (!isNewStore) data.store_code = currentStore.code;
    
    // Step 1: Submit form data (no photos)
    const result = await apiCall('addVisit', data);
    
    if (!result?.success) {
        showToast('Error: ' + (result?.error || 'Failed'), 'error');
        btn.disabled = false;
        btn.innerHTML = 'Submit Visit';
        return;
    }
    
    const storeCode = result.storeCode || currentStore?.code;
    
    // Step 2: Upload photos one by one
    let uploadedCount = 0;
    if (photos.length > 0) {
        btn.innerHTML = '<div class="spinner"></div> Uploading photos...';
        
        for (let i = 0; i < photos.length; i++) {
            btn.innerHTML = '<div class="spinner"></div> Photo ' + (i + 1) + '/' + photos.length;
            const photoResult = await uploadPhoto(storeCode, photos[i].data);
            if (photoResult?.success) uploadedCount++;
        }
    }
    
    // Update local state
    if (isNewStore) {
        stores.push({ code: storeCode, name: data.business_name, location: data.store_location || data.address, type: data.business_type });
    }
    data.store_code = storeCode;
    data.photo_count = uploadedCount;
    visits.unshift(data);
    
    const msg = uploadedCount > 0 ? 'Saved + ' + uploadedCount + ' photos!' : 'Saved!';
    showToast(msg, 'success');
    
    setTimeout(() => {
        showScreen('select');
        document.getElementById('total-stores').textContent = stores.length;
        document.getElementById('total-visits').textContent = visits.length;
    }, 1000);
    
    btn.disabled = false;
    btn.innerHTML = 'Submit Visit';
}

// ADMIN
function toggleAdmin() { document.getElementById('admin-panel').classList.toggle('open'); document.getElementById('admin-overlay').classList.toggle('open'); }
function showAdminTab(tab, btn) { document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active')); document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active')); btn.classList.add('active'); document.getElementById('admin-' + tab).classList.add('active'); }
function toggleOptionsField() { document.getElementById('options-row').style.display = ['select', 'multiselect'].includes(document.getElementById('new-field-type').value) ? 'block' : 'none'; }

function renderFieldConfigList() {
    const c = document.getElementById('field-config-list');
    const grouped = {};
    fieldConfig.forEach(f => { if (!grouped[f.section]) grouped[f.section] = []; grouped[f.section].push(f); });
    c.innerHTML = Object.entries(grouped).map(([s, fields]) => {
        const m = sectionMeta[s] || { icon: 'üìã', title: s };
        return '<div class="section-group"><div class="section-group-title">' + m.icon + ' ' + m.title + '</div>' + fields.map(f => '<div class="field-config-item"><div class="field-info"><div class="field-name">' + f.label + '</div><div class="field-meta">' + f.type + '</div></div><div class="field-toggle ' + (f.active ? 'active' : '') + '" onclick="toggleFieldActive(\'' + f.id + '\')"></div></div>').join('') + '</div>';
    }).join('');
}

function toggleFieldActive(id) { const f = fieldConfig.find(x => x.id === id); if (f) { f.active = !f.active; renderFieldConfigList(); showToast(f.label + (f.active ? ' on' : ' off')); } }

function addNewField() {
    const label = document.getElementById('new-field-label').value.trim();
    if (!label) { showToast('Enter label', 'error'); return; }
    const id = label.toLowerCase().replace(/[^a-z0-9]+/g, '_');
    if (fieldConfig.find(f => f.id === id)) { showToast('Exists', 'error'); return; }
    const nf = { id, label, type: document.getElementById('new-field-type').value, section: document.getElementById('new-field-section').value, required: false, active: true };
    const opts = document.getElementById('new-field-options').value.trim();
    if (opts) nf.options = opts.split(',').map(o => o.trim());
    fieldConfig.push(nf);
    document.getElementById('new-field-label').value = '';
    document.getElementById('new-field-options').value = '';
    renderFieldConfigList();
    showToast('Added!', 'success');
    document.querySelectorAll('.admin-tab')[0].click();
}

function showToast(msg, type) { const t = document.getElementById('toast'); t.textContent = msg; t.className = 'toast ' + (type || '') + ' show'; setTimeout(() => t.classList.remove('show'), 3000); }
document.getElementById('visit-modal').addEventListener('click', e => { if (e.target.id === 'visit-modal') closeModal(); });
</script>
</body>
</html>
